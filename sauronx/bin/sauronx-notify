#!/usr/bin/env bash

# Customizable script called when a SauronX submission status changes
# You can make a new script and update status_notify_cmd in the config.toml to run it

set -euo pipefail
IFS=$'\n\t'

if (( $# == 5 )); then

	sub_stat=$1
	sub_stat_level=$2
	submission=$3
	description=$4
	valinor_user=$5
	sub_stat="${sub_stat//_/ }"

	function get_slack_user {
		echo $( grep "${1}" $HOME/valar_configs/slack_users.properties|cut -d'=' -f2 )
	}
	slack_user=$( get_slack_user "${valinor_user}" )

	status_lower=$( echo $sub_stat | tr '[:upper:]' '[:lower:]' )
	if [[ "${slack_user}" != '' ]]; then
			slack_user="<@${slack_user}> "
	fi

	post_str="{'text':'${slack_user} S${SAURON_NUMBER} ${status_lower} ${submission} (${description})'}"
	curl -X POST -H 'Content-type: application/json' --data $post_str __TOKEN__
	#/home/sellolab/code/sauronx/bin/bombadil "${slack_user} S${SAURON_NUMBER} ${status_lower} ${submission} (${description})"

elif (( $# ==  1 )); then

	sub_stat=$1

	status_lower=$(echo $sub_stat | tr '[:upper:]' '[:lower:]')
	post_str="{'text':'S${SAURON_NUMBER} ${status_lower}'}"
	curl -X POST -H 'Content-type: application/json' --data $post_str __TOKEN__
else
	echo "No action taken in notification"
fi
